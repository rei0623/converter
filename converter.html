<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Markdown Workspace</title>

    <!-- 1. åŸºæœ¬ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 2. CodeMirror (é«˜æ©Ÿèƒ½ã‚¨ãƒ‡ã‚£ã‚¿) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/base16-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/display/placeholder.min.js"></script>

    <!-- 3. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ & WYSIWYGç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>

    <!-- 4. ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (Marpit) -->
    <script src="https://cdn.jsdelivr.net/npm/@marp-team/marpit/dist/marpit.browser.js"></script>


    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨CSSå¤‰æ•° --- */
        :root {
            --bg-color: #f4f7f9; --text-color: #333; --container-bg: #fff; --border-color: #d1d5db;
            --header-color: #2c3e50; --sub-text-color: #7f8c8d; --preview-bg: #fdfdfd;
            --button-bg: #3498db; --button-hover-bg: #2980b9; --editor-theme: 'base16-light';
            --special-button-bg: #16a085; --special-button-hover-bg: #117a65;
        }
        body.dark-mode {
            --bg-color: #2c3e50; --text-color: #ecf0f1; --container-bg: #34495e; --border-color: #4a5568;
            --header-color: #ecf0f1; --sub-text-color: #bdc3c7; --preview-bg: #2d343b;
            --button-bg: #e67e22; --button-hover-bg: #d35400; --editor-theme: 'material-darker';
            --special-button-bg: #27ae60; --special-button-hover-bg: #229954;
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 90%; max-width: 1400px; background-color: var(--container-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; transition: background-color 0.3s; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .title-group { text-align: left; }
        h1 { color: var(--header-color); margin: 0; font-size: 1.8rem; }
        p { color: var(--sub-text-color); font-size: 1rem; margin: 5px 0 0; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .main-content { display: flex; gap: 20px; }
        .panel { flex: 1; display: flex; flex-direction: column; }
        .panel label { font-weight: bold; margin-bottom: 8px; color: var(--header-color); }
        .CodeMirror { height: 65vh; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; }
        .preview-area { height: calc(65vh + 34px); padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; overflow-y: auto; background-color: var(--preview-bg); color: var(--text-color); }
        .preview-area:focus { outline: 2px solid var(--button-bg); box-shadow: 0 0 5px var(--button-bg); }
        .editor-footer { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--sub-text-color); padding: 5px 10px; background-color: var(--preview-bg); border: 1px solid var(--border-color); border-top: none; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
        .actions-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .actions { text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        
        button { background-color: var(--button-bg); color: white; border: none; padding: 8px 15px; font-size: 14px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-weight: bold; }
        button:hover { background-color: var(--button-hover-bg); }
        button:active { transform: scale(0.98); }
        #clearButton { background-color: #c0392b; }
        #copyButton.copied, .export-button.processing { background-color: #2ecc71; }
        .export-button { background-color: var(--special-button-bg); }
        .export-button:hover { background-color: var(--special-button-hover-bg); }

        /* ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        #presentation-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1000; overflow: auto; }
        .marp-root { width: 100%; height: 100%; }
        /* MarpitãŒç”Ÿæˆã™ã‚‹ã‚¹ãƒ©ã‚¤ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .marp-root svg { width: 100%; height: 100%; }

        /* ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ */
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--special-button-bg); }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="container" id="editor-workspace">
        <header>
            <div class="title-group">
                <h1>Ultimate Markdown Workspace</h1>
                <p>æ›¸ãã€è¦‹ã›ã‚‹ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã€‚ã™ã¹ã¦ã‚’ã“ã®å ´æ‰€ã§ã€‚</p>
            </div>
            <div class="header-actions">
                <button id="darkModeToggle">ğŸŒ™</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="panel">
                <div class="actions-toolbar">
                    <div class="toolbar">
                        <button data-action="bold">B</button> <button data-action="italic">I</button> <button data-action="link">Link</button>
                        <button data-action="list-ul">- List</button> <button data-action="list-ol">1. List</button> <button data-action="code">`Code`</button>
                    </div>
                    <button id="clearButton">ã‚¯ãƒªã‚¢</button>
                </div>
                <div id="editor-container"></div>
                <div class="editor-footer">
                    <div id="status-info">Markdown</div>
                    <div id="counter">æ–‡å­—æ•°: 0 | å˜èªæ•°: 0</div>
                </div>
            </div>
            <div class="panel">
                <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (ç›´æ¥ç·¨é›†ã§ãã¾ã™)</label>
                <div id="html-output" class="preview-area" contenteditable="true"></div>
            </div>
        </div>

        <div class="actions">
            <button id="copyButton">è¦‹ãŸã¾ã¾ã‚³ãƒ”ãƒ¼</button>
            <button id="export-pdf" class="export-button">PDFã§ä¿å­˜</button>
        </div>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºç”¨ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="presentation-container"></div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <i class="sidebar-icon fas fa-pen-to-square active" data-panel="editor" title="ã‚¨ãƒ‡ã‚£ã‚¿"></i>
        <i class="sidebar-icon fas fa-robot" data-panel="ai" title="AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ"></i>
        <i class="sidebar-icon fas fa-file-export" data-panel="export" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"></i>
        <i class="sidebar-icon fas fa-cog" data-panel="settings" title="è¨­å®š"></i>
    </div>

    <script>
        // --- è¦ç´ å–å¾— ---
        const htmlOutput = document.getElementById('html-output');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const clearButton = document.getElementById('clearButton');
        const toolbar = document.querySelector('.toolbar');
        const counterElement = document.getElementById('counter');
        const copyButton = document.getElementById('copyButton');
        const exportPdfButton = document.getElementById('export-pdf');
        const presentationToggle = document.getElementById('presentation-toggle');
        const editorWorkspace = document.getElementById('editor-workspace');
        const presentationContainer = document.getElementById('presentation-container');

        let editor; // CodeMirrorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let turndownService; // Turndown.jsã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        
        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.textContent = 'â˜€ï¸';
            } else {
                darkModeToggle.textContent = 'ğŸŒ™';
            }
            initEditor(savedDarkMode);
            // Turndownã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
            turndownService = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced' });
            addPreviewEditorListener();
        });

        const initEditor = (isDark) => {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            editor = CodeMirror(container, {
                value: localStorage.getItem('markdownContent') || '# Welcome to Ultimate Markdown Workspace!\n\nStart writing here, or edit the preview on the right.',
                mode: 'markdown',
                theme: isDark ? 'material-darker' : 'base16-light',
                lineNumbers: true,
                lineWrapping: true,
            });
            editor.on('change', (cm) => {
                const content = cm.getValue();
                updatePreview(content);
                updateCounter(content);
                saveContent(content);
            });
            const initialContent = editor.getValue();
            updatePreview(initialContent);
            updateCounter(initialContent);
        };
        
        // --- é–¢æ•°å®šç¾© ---
        const updatePreview = (content) => {
            const currentScroll = htmlOutput.scrollTop; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿æŒ
            htmlOutput.innerHTML = marked.parse(content);
            htmlOutput.scrollTop = currentScroll; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
        };
        const updateCounter = (content) => {
            const charCount = content.length;
            const wordCount = content.split(/\s+/).filter(Boolean).length;
            counterElement.textContent = `æ–‡å­—æ•°: ${charCount} | å˜èªæ•°: ${wordCount}`;
        };
        const saveContent = (content) => { localStorage.setItem('markdownContent', content); };
        const applyStyle = (action) => {
            const selection = editor.getSelection();
            let replacement = '';
            switch (action) {
                case 'bold': replacement = `**${selection}**`; break;
                case 'italic': replacement = `*${selection}*`; break;
                case 'link':
                    const url = prompt('ãƒªãƒ³ã‚¯å…ˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'https://');
                    if (url) replacement = `[${selection || 'ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ'}](${url})`;
                    else return;
                    break;
                case 'list-ul': replacement = `- ${selection}`; break;
                case 'list-ol': replacement = `1. ${selection}`; break;
                case 'code': replacement = `\`${selection}\``; break;
            }
            editor.replaceSelection(replacement, 'end');
            editor.focus();
        };

        // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç·¨é›†æ©Ÿèƒ½ ---
        const addPreviewEditorListener = () => {
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã«ã‚¨ãƒ‡ã‚£ã‚¿ã‚’æ›´æ–°
            htmlOutput.addEventListener('blur', () => {
                const htmlContent = htmlOutput.innerHTML;
                const markdownContent = turndownService.turndown(htmlContent);

                // å†…å®¹ãŒå®Ÿéš›ã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿ã‚¨ãƒ‡ã‚£ã‚¿ã‚’æ›´æ–°
                if (markdownContent !== editor.getValue()) {
                    // setValueã¯changeã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã€
                    // ãã®ä¸­ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€ã‚«ã‚¦ãƒ³ã‚¿æ›´æ–°ã€ä¿å­˜ãŒè‡ªå‹•çš„ã«è¡Œã‚ã‚Œã‚‹
                    editor.setValue(markdownContent);
                }
            });
        };

        // --- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
        const setButtonProcessing = (button, isProcessing, originalText) => {
            if (isProcessing) {
                button.textContent = 'å‡¦ç†ä¸­...';
                button.disabled = true;
                button.classList.add('processing');
            } else {
                button.textContent = originalText;
                button.disabled = false;
                button.classList.remove('processing');
            }
        };

        exportPdfButton.addEventListener('click', async () => {
            const originalText = exportPdfButton.textContent;
            setButtonProcessing(exportPdfButton, true);

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            try {
                const canvas = await html2canvas(htmlOutput, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                let heightLeft = pdfHeight;
                let position = 0;
                const pageHeight = pdf.internal.pageSize.getHeight();

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;

                while (heightLeft > 0) {
                    position = heightLeft - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('document.pdf');
            } catch (e) {
                console.error("PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:", e);
                alert("PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            } finally {
                setButtonProcessing(exportPdfButton, false, originalText);
            }
        });

        // --- ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ (ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å®šç¾©ã®ã¿ã¨ã—ã¾ã™) ---
        const setupPresentationListener = () => {
            // ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ã€HTMLã«<input type="checkbox" id="presentation-toggle">ãŒå¿…è¦ã§ã™ã€‚
            if (!presentationToggle) return; 

            presentationToggle.addEventListener('change', () => {
                if (presentationToggle.checked) {
                    const markdown = editor.getValue();
                    const marpit = new Marpit.Marpit();
                    const { html, css } = marpit.render(markdown);

                    presentationContainer.innerHTML = `<style>${css}</style><div class="marp-root">${html}</div>`;
                    editorWorkspace.style.display = 'none';
                    presentationContainer.style.display = 'block';

                    document.addEventListener('keydown', exitPresentationOnEsc);
                } else {
                    editorWorkspace.style.display = 'block';
                    presentationContainer.style.display = 'none';
                    document.removeEventListener('keydown', exitPresentationOnEsc);
                }
            });
        };
        const exitPresentationOnEsc = (e) => {
            if (e.key === 'Escape' && presentationToggle) {
                presentationToggle.checked = false;
                presentationToggle.dispatchEvent(new Event('change'));
            }
        };
        setupPresentationListener(); // ãƒ—ãƒ¬ã‚¼ãƒ³æ©Ÿèƒ½ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š

        // --- æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        clearButton.addEventListener('click', () => { if (confirm('å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) { editor.setValue(''); editor.focus(); }});
        toolbar.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const action = e.target.dataset.action; if (action) applyStyle(action); }});
        
        copyButton.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(htmlOutput.innerText);
                copyButton.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†!';
                copyButton.classList.add('copied');
                setTimeout(() => {
                    copyButton.textContent = 'è¦‹ãŸã¾ã¾ã‚³ãƒ”ãƒ¼';
                    copyButton.classList.remove('copied');
                }, 1500);
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        });

        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            darkModeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            editor.setOption('theme', isDark ? 'material-darker' : 'base16-light');
        });
        
    </script>
</body>
</html>